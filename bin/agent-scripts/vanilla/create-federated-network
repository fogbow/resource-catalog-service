#!/bin/bash
set -e
absoluteIpsecConfPath="/etc/ipsec.conf"
firstNetwork() {
        isCommented=$( cat $absoluteIpsecConfPath | grep "leftsubnet" | awk '(index($1, "#") != 0) {print 0}' )
        leftSubnet=$(grep "leftsubnet" $absoluteIpsecConfPath | awk -F "=" '{print $2}')
        if [ -n "$isCommented" ] || [ -z "${leftSubnet// }" ]; then
            echo true
        else
            echo false
        fi
}

left=$1
leftid=$2
leftsubnet=$3

if [ "$( firstNetwork )" = "true" ]; then
    config_setup="config setup"

    config_default="\nconn %default
    ikelifetime=60m
    keylife=20m
    rekeymargin=3m
    keyingtries=1
    authby=secret
    mobike=no
    keyexchange=ikev2\n"

    tunnel_param_configs="\nconn tunnel
    right=%any
    rightsubnet="$leftsubnet"
    leftfirewall=yes
    left="$left"
    leftsubnet="$leftsubnet"
    leftid="$leftid"
    type=tunnel
    auto=start"

    other_tunnel_configs="ike=aes256-sha2_256-modp1024!
    esp=aes256-sha2_256!
    lifetime=8h
    dpddelay=30
    dpdtimeout=120
    dpdaction=restart"

    echo -e "$config_setup
    $config_default
    $tunnel_param_configs
    $other_tunnel_configs" > $absoluteIpsecConfPath
else
    leftSubnets=$( cat $absoluteIpsecConfPath | grep leftsubnet | awk '{split($0,a,"="); print a[2]}' )
    newSubnet=",$leftsubnet"
    awk -v old="$leftSubnets" -v new="$leftSubnets$newSubnet" '{sub(old, new)}1' $absoluteIpsecConfPath > $absoluteIpsecConfPath.tmp
    cat $absoluteIpsecConfPath.tmp > $absoluteIpsecConfPath
    rm $absoluteIpsecConfPath.tmp
fi

sysctl net.ipv4.ip_forward=1
sysctl net.ipv6.conf.all.forwarding=1

sudo ipsec rereadsecrets
sudo ipsec restart
rm $0
